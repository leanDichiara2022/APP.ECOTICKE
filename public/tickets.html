<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GestiÃ³n de Tickets</title>
  <link rel="stylesheet" href="/css/tickets.css" />
  <script src="/scripts/scripts.js" defer></script>
</head>
<body>
  <div class="tickets-container">
    <header class="tickets-header">
      <div class="logo-title">
        <a href="/">
          <img src="./images/TickECO-Photoroom.png" alt="Logo" />
        </a>
        <h1>GestiÃ³n y Historial de Tickets</h1>
      </div>
      <button onclick="window.location.href='/main.html'" class="btn-back">â¬… Volver atrÃ¡s</button>
    </header>

    <main class="tickets-main">
      <section class="tickets-section">
        <h2>Historial de Tickets</h2>

        <div class="table-container">
          <table class="ticket-history">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Destinatario</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="ticketHistoryTable">
              <!-- Se llena dinÃ¡micamente -->
            </tbody>
          </table>
        </div>

        <button id="clearHistory" class="btn-danger">ðŸ—‘ Borrar Historial</button>
      </section>
    </main>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const clearBtn = document.getElementById('clearHistory');
      const toastContainer = document.getElementById('toastContainer');

      const showInlineToast = (msg, type = 'success', time = 2500) => {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerText = msg;
        toastContainer.appendChild(t);
        setTimeout(() => t.remove(), time);
      };

      const openConfirmModal = ({ title = "Confirmar", text = "Â¿EstÃ¡s seguro?", confirmText = "Aceptar", cancelText = "Cancelar" }) => {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = `
            <div class="modal-card">
              <div class="modal-title">${title}</div>
              <div class="modal-text">${text}</div>
              <div class="modal-actions">
                <button class="btn cancel">${cancelText}</button>
                <button class="btn danger">${confirmText}</button>
              </div>
            </div>`;
          document.body.appendChild(overlay);
          overlay.querySelector('.btn.cancel').addEventListener('click', () => { overlay.remove(); resolve(false); });
          overlay.querySelector('.btn.danger').addEventListener('click', () => { overlay.remove(); resolve(true); });
        });
      };

      async function clearAllHistory() {
        try {
          const res = await fetch('/api/history/data');
          if (!res.ok) return showInlineToast('No se pudo obtener el historial.', 'error');
          const list = await res.json();
          if (!Array.isArray(list) || list.length === 0)
            return showInlineToast('No hay tickets para eliminar.', 'error');

          const confirmed = await openConfirmModal({
            title: 'Borrar todo el historial',
            text: `Se eliminarÃ¡n ${list.length} registros. Esta acciÃ³n no se puede deshacer.`,
            confirmText: 'Borrar todo',
            cancelText: 'Cancelar'
          });
          if (!confirmed) return;

          const deletes = list.map(item => fetch(`/api/history/delete/${item._id}`, { method: 'DELETE' }));
          const results = await Promise.all(deletes);
          const okCount = results.filter(r => r.ok).length;
          showInlineToast(`${okCount} de ${list.length} registros eliminados.`, 'success');
          if (typeof window.fetchHistory === 'function') window.fetchHistory();
          else setTimeout(() => location.reload(), 800);
        } catch (err) {
          console.error('Error:', err);
          showInlineToast('Error borrando historial.', 'error');
        }
      }

      if (clearBtn) clearBtn.addEventListener('click', (e) => { e.preventDefault(); clearAllHistory(); });
      if (typeof window.fetchHistory === 'function') window.fetchHistory();
    });
  </script>
</body>
</html>
